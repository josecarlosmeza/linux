#!/bin/bash

# 1. Definir rutas de archivos
SCR_PATH="/usr/local/bin/db-guardian.sh"
SVC_PATH="/etc/systemd/system/db-guardian.service"
DB_MASTER="/root/usuarios.db"
DB_LIMITER="/root/usuarios-limitador.db"
DB_BACKUP="/root/usuarios.backup"

echo "--- Iniciando Instalación del Sistema de Seguridad de DB ---"

# 2. Crear el script del Guardián
cat << EOF > $SCR_PATH
#!/bin/bash
# Script: Guardian de Sincronización y Recuperación
# Master: $DB_MASTER (Editable)
# Limiter: $DB_LIMITER (Solo Lectura para PAM)

while true; do
    if [ -f "$DB_MASTER" ]; then
        lineas=\$(wc -l < "$DB_MASTER")
        
        # Si el maestro tiene contenido (más de 5 líneas), actualizamos todo
        if [ "\$lineas" -gt 5 ]; then
            cp "$DB_MASTER" "$DB_LIMITER"
            cp "$DB_MASTER" "$DB_BACKUP"
            chmod 644 "$DB_LIMITER"
        
        # Si el maestro se vació (error de sistema), restauramos del backup
        elif [ "\$lineas" -le 1 ]; then
            if [ -f "$DB_BACKUP" ]; then
                cp "$DB_BACKUP" "$DB_MASTER"
                cp "$DB_BACKUP" "$DB_LIMITER"
                logger "DB-GUARDIAN: Se detectó borrado en Master. Restaurando datos..."
            fi
        fi
    fi
    sleep 5
done
EOF

chmod +x $SCR_PATH

# 3. Crear el servicio de Systemd
cat << EOF > $SVC_PATH
[Unit]
Description=Guardian de Base de Datos SSHPlus
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash $SCR_PATH
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# 4. Asegurar que existan los archivos iniciales para evitar errores
touch $DB_MASTER
touch $DB_LIMITER
touch $DB_BACKUP

# 5. Recargar y Activar el servicio
systemctl daemon-reload
systemctl enable db-guardian.service
systemctl restart db-guardian.service

echo "--- Instalación Completada ---"
echo "Comandos útiles:"
echo "systemctl status db-guardian  <- Ver si está corriendo"
echo "journalctl -u db-guardian -f  <- Ver logs en tiempo real"
