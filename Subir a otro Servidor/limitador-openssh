#!/bin/bash
echo "--- üõ†Ô∏è  INSTALACI√ìN DEL LIMITADOR OPENSSH (VERSI√ìN SEGURA) ---"
echo ""

# --- CONFIGURACI√ìN DE RUTAS ---
LIMITER_PATH="/usr/bin/check_ssh_limits.sh"
DB_SOURCE="/root/usuarios.db"
PAM_SSHD_FILE="/etc/pam.d/sshd"

# --- 1. CREAR ARCHIVO DE L√çMITES (Si no existe) ---
echo "--- 1. Configurando base de datos de usuarios: $DB_SOURCE ---"
if [ ! -f "$DB_SOURCE" ]; then
    sudo tee "$DB_SOURCE" > /dev/null <<EOF
# USUARIO LIMITE
* 3
REDLIBRE 10
EOF
    echo "‚úÖ Archivo de l√≠mites creado."
else
    echo "‚úÖ El archivo de l√≠mites ya existe."
fi
chmod 644 "$DB_SOURCE"

# --- 2. CREAR SCRIPT LIMITADOR CON EXCEPCI√ìN PARA ROOT ---
echo "--- 2. Creando Script Limitador en $LIMITER_PATH ---"
sudo tee "$LIMITER_PATH" > /dev/null <<'EOF_LIMITER'
#!/bin/bash
# Script de l√≠mite ejecutado por PAM
DB_SOURCE="/root/usuarios.db"
USER="$PAM_USER"

# 1. EXCEPCI√ìN TOTAL PARA ROOT (Seguridad ante bloqueos)
if [ "$USER" == "root" ] || [ -z "$USER" ]; then
    exit 0
fi

# 2. OBTENER L√çMITE DEL ARCHIVO
# Intenta buscar el usuario, si no, busca el global (*), si no, usa 3 por defecto.
MAX_ALLOWED=$(grep "^$USER " "$DB_SOURCE" 2>/dev/null | awk '{print $2}')
if [ -z "$MAX_ALLOWED" ]; then
    MAX_ALLOWED=$(grep "^\* " "$DB_SOURCE" 2>/dev/null | awk '{print $2}')
fi
MAX_ALLOWED=${MAX_ALLOWED:-3}

# 3. CONTAR SESIONES ACTUALES (Excluyendo procesos de sistema)
# 'pgrep -u' asegura que solo contamos procesos de ese usuario espec√≠fico.
CURRENT_SESSIONS=$(pgrep -u "$USER" -f "sshd:" | wc -l)

# 4. APLICAR L√ìGICA DE BLOQUEO
# Usamos -gt (mayor que) para dar margen a la sesi√≥n que est√° entrando.
if [ "$CURRENT_SESSIONS" -gt "$MAX_ALLOWED" ]; then
    logger -t ssh_limiter "DENIED: $USER excedi√≥ el l√≠mite de $MAX_ALLOWED (Activas: $CURRENT_SESSIONS)"
    exit 1
fi

# 5. SIEMPRE PERMITIR POR DEFECTO SI NADA DE LO ANTERIOR FALL√ì
exit 0
EOF_LIMITER

sudo chmod +x "$LIMITER_PATH"
echo "‚úÖ Script limitador instalado con protecci√≥n para root."

# --- 3. CONFIGURAR PAM ---
echo "--- 3. Configurando PAM ($PAM_SSHD_FILE) ---"
# Limpiar instalaciones previas
sudo sed -i "/$LIMITER_PATH/d" "$PAM_SSHD_FILE"

# A√±adir la l√≠nea de ejecuci√≥n de forma segura
# Se coloca antes de pam_unix para que verifique el l√≠mite antes de dar el acceso final
sudo sed -i "/^account\s*required\s*pam_unix.so/i account\trequired\t\tpam_exec.so $LIMITER_PATH" "$PAM_SSHD_FILE"
echo "‚úÖ L√≠nea a√±adida a PAM."

# --- 4. REINICIAR SERVICIOS ---
echo "--- 4. Reiniciando OpenSSH ---"
sudo systemctl restart sshd
echo "‚úÖ Instalaci√≥n completada con √©xito."
echo ""
echo "‚ö†Ô∏è  NOTA: El usuario 'root' ahora tiene acceso total garantizado."
