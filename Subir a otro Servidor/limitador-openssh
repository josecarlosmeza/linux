#!/bin/bash
echo "--- üõ†Ô∏è  INICIANDO INSTALACI√ìN DEL LIMITADOR DE SESIONES OPENSSH ---"
echo ""

# --- CONFIGURACI√ìN DE RUTAS ---
LIMITER_PATH="/usr/bin/check_ssh_limits.sh"
DB_SOURCE="/root/usuarios.db"
PAM_SSHD_FILE="/etc/pam.d/sshd"

# --- 1. CREAR ARCHIVO DE L√çMITES DE EJEMPLO ---
echo "--- 1. Creando archivo de l√≠mites de ejemplo: $DB_SOURCE ---"
if [ ! -f "$DB_SOURCE" ]; then
    sudo tee "$DB_SOURCE" > /dev/null <<EOF
# USUARIO LIMITE
* 3  # L√≠mite global por defecto: 3 sesiones
REDLIBRE 10 # L√≠mite espec√≠fico para REDLIBRE: 10 sesiones
EOF
    echo "‚úÖ Archivo de l√≠mites inicial creado."
else
    echo "‚úÖ Archivo de l√≠mites ya existe. Se usar√° el contenido actual."
fi

# --- 2. CREAR SCRIPT LIMITADOR (PAM_EXEC) ---
echo "--- 2. Creando Script Limitador: $LIMITER_PATH ---"
sudo tee "$LIMITER_PATH" > /dev/null <<'EOF_LIMITER'
#!/bin/bash
# Script de l√≠mite ejecutado por OpenSSH a trav√©s de PAM
DB_SOURCE="/root/usuarios.db"
USER="$PAM_USER"
MAX_ALLOWED=3

# 1. Obtener L√≠mite del Archivo de Base de Datos
USER_LIMIT=$(grep "^$USER " "$DB_SOURCE" 2>/dev/null | awk '{print $2}')

if [ -z "$USER_LIMIT" ]; then
    USER_LIMIT=$(grep "^\* " "$DB_SOURCE" 2>/dev/null | awk '{print $2}')
fi

if [ -n "$USER_LIMIT" ]; then
    MAX_ALLOWED="$USER_LIMIT"
fi

# 2. Contar Sesiones Activas (M√©todo 'who')
# Contamos cu√°ntas veces aparece el nombre del usuario (la sesi√≥n actual cuenta).
CURRENT_SESSIONS=$(who | grep -c "^$USER ")

# 3. Aplicar L√≠mite
if [ "$CURRENT_SESSIONS" -ge "$MAX_ALLOWED" ]; then
    logger -t ssh_limiter "DENIED: Login para $USER. Sesiones: $CURRENT_SESSIONS (Max: $MAX_ALLOWED)."
    exit 1
else
    logger -t ssh_limiter "PERMITIDO: Login para $USER. Sesiones: $CURRENT_SESSIONS (Max: $MAX_ALLOWED)."
    exit 0
fi
EOF_LIMITER
sudo chmod +x "$LIMITER_PATH"
echo "‚úÖ Script limitador creado y con permisos de ejecuci√≥n."

# --- 3. CONFIGURAR PAM PARA EJECUTAR EL L√çMITE ---
echo "--- 3. Configurando PAM ($PAM_SSHD_FILE) ---"

# 3.1. Eliminar cualquier l√≠nea previa que ejecute este script para evitar duplicados.
sudo sed -i "/$LIMITER_PATH/d" "$PAM_SSHD_FILE"

# 3.2. A√±adir la l√≠nea de ejecuci√≥n en la fase 'account' (Verificaci√≥n de cuenta, antes de iniciar sesi√≥n).
# Usamos 'account' porque es donde se verifica si el usuario puede iniciar sesi√≥n.
sudo sed -i "/^account\s*required\s*pam_unix.so/i account\trequired\t\tpam_exec.so expose_authtok $LIMITER_PATH" "$PAM_SSHD_FILE"
echo "‚úÖ L√≠nea de ejecuci√≥n de l√≠mite a√±adida a la secci√≥n 'account' de PAM."

# --- 4. REINICIAR OPENSSH ---
echo "--- 4. Reiniciando OpenSSH ---"
sudo systemctl daemon-reload
sudo systemctl restart sshd
echo "‚úÖ OpenSSH reiniciado. El sistema de limitaci√≥n de sesiones est√° activo."
echo ""
echo "--- üéâ INSTALACI√ìN COMPLETADA ---"
echo ""
echo "‚ñ∂Ô∏è  PRUEBA:"
echo "1. Intenta iniciar sesi√≥n con tu usuario de prueba (ej. REDLIBRE)."
echo "2. Abre m√°s de 10 sesiones para ver el rechazo (basado en el l√≠mite del archivo)."
echo "3. Revisa el log de rechazo con:"
echo "   sudo journalctl -n 50 | grep 's
sh_limiter'"
