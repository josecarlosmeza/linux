#!/bin/bash
echo "--- ðŸ› ï¸  INSTALACIÃ“N DEL LIMITADOR CORREGIDO (MÃ‰TODO PS) ---"
echo ""

# --- CONFIGURACIÃ“N DE RUTAS ---
LIMITER_PATH="/usr/bin/check_ssh_limits.sh"
DB_SOURCE="/root/usuarios.db"
PAM_SSHD_FILE="/etc/pam.d/sshd"

# --- 1. CREAR ARCHIVO DE LÃMITES SI NO EXISTE ---
if [ ! -f "$DB_SOURCE" ]; then
    sudo tee "$DB_SOURCE" > /dev/null <<EOF
# USUARIO LIMITE
* 3
REDLIBRE 10
EOF
    echo "âœ… Archivo $DB_SOURCE creado."
fi

# --- 2. CREAR SCRIPT LIMITADOR CORREGIDO ---
# Este script ahora usa 'ps' en lugar de 'who' para ver tÃºneles VPN
sudo tee "$LIMITER_PATH" > /dev/null <<'EOF_LIMITER'
#!/bin/bash
DB_SOURCE="/root/usuarios.db"
USER="$PAM_USER"
MAX_ALLOWED=3

# 1. Obtener LÃ­mite
USER_LIMIT=$(grep "^$USER " "$DB_SOURCE" 2>/dev/null | awk '{print $2}')
[ -z "$USER_LIMIT" ] && USER_LIMIT=$(grep "^\* " "$DB_SOURCE" 2>/dev/null | awk '{print $2}')
[ -n "$USER_LIMIT" ] && MAX_ALLOWED="$USER_LIMIT"

# 2. Contar Sesiones (MÃ‰TODO PS - Detecta tÃºneles y notty)
# Contamos procesos 'sshd: usuario' excluyendo el proceso [priv] de root
CURRENT_SESSIONS=$(ps aux | grep "sshd: $USER" | grep -v "grep" | grep -v "priv" | wc -l)

# 3. Aplicar LÃ­mite
if [ "$CURRENT_SESSIONS" -ge "$MAX_ALLOWED" ]; then
    logger -t ssh_limiter "DENIED: $USER alcanzÃ³ el lÃ­mite. ($CURRENT_SESSIONS/$MAX_ALLOWED)"
    exit 1
else
    logger -t ssh_limiter "ALLOWED: $USER dentro del lÃ­mite. ($CURRENT_SESSIONS/$MAX_ALLOWED)"
    exit 0
fi
EOF_LIMITER

sudo chmod +x "$LIMITER_PATH"
echo "âœ… Script limitador actualizado con soporte para tÃºneles."

# --- 3. CONFIGURAR PAM ---
sudo sed -i "/$LIMITER_PATH/d" "$PAM_SSHD_FILE"
sudo sed -i "/^account\s*required\s*pam_unix.so/i account\trequired\t\tpam_exec.so expose_authtok $LIMITER_PATH" "$PAM_SSHD_FILE"
echo "âœ… ConfiguraciÃ³n de PAM actualizada."

# --- 4. REINICIAR SERVICIOS Y LIMPIAR ---
sudo systemctl restart sshd
echo "âœ… SSHD reiniciado."

# Matar procesos antiguos para limpiar el servidor
echo "âš ï¸ Limpiando procesos antiguos del usuario REDLIBRE..."
pkill -u REDLIBRE 2>/dev/null

echo ""
echo "--- ðŸŽ‰ INSTALACIÃ“N FINALIZADA ---"
echo "Ahora el sistema contarÃ¡ correctamente incluso si usan HTTP Custom o similares."
