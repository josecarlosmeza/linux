#!/bin/bash

# --- Script de Ajuste de badvpn-udpgw: Reducción de Logs ---

echo "========================================================"
echo " INICIO: Ajuste de Logs y Re-inicio de badvpn-udpgw "
echo "========================================================"

# --- Variables de Configuración ---
SERVICE_FILE="/etc/systemd/system/badvpn-udpgw.service"
MAX_CLIENTS=1000
MAX_CONNECTIONS=10

# Función para verificar si un comando tuvo éxito
check_status() {
    if [ $? -ne 0 ]; then
        echo "❌ ERROR: Falló el paso anterior. Abortando."
        exit 1
    fi
}

# --- 1. Detección de Núcleos (Necesaria para mantener --nthreads) ---
NUM_CORES=$(nproc 2>/dev/null || lscpu -p | grep -c '^#' || grep -c ^processor /proc/cpuinfo)
NUM_THREADS=${NUM_CORES}

if [ "$NUM_THREADS" -eq 0 ]; then
    NUM_THREADS=1
fi
echo "✅ Threads detectados: ${NUM_THREADS}. Nivel de log: ERROR."

# --- 2. Re-Creación y Configuración del Servicio Systemd (Con --loglevel error) ---
echo -e "\n--- 2. Recreando el servicio Systemd con --loglevel error ---"

# Nueva línea ExecStart con --loglevel error
NEW_EXEC_START="/usr/local/bin/badvpn-udpgw --loglevel error --listen-addr 127.0.0.1:7300 --nthreads ${NUM_THREADS} --max-clients ${MAX_CLIENTS} --max-connections-for-client ${MAX_CONNECTIONS}"

cat << EOF | sudo tee ${SERVICE_FILE}
[Unit]
Description=UDP Forwarder for badvpn-tun2socks
After=network.target

[Service]
ExecStart=${NEW_EXEC_START}
Restart=always
Type=simple

[Install]
WantedBy=multi-user.target
EOF
check_status

# Iniciar y habilitar el servicio
sudo systemctl daemon-reload
sudo systemctl restart badvpn-udpgw.service
check_status


# --- 3. Verificación de Estado Final ---
echo -e "\n--- 3. Verificación de Estado Final ---"
sudo systemctl status badvpn-udpgw.service

echo -e "\n========================================================"
echo "                 ✅ LOGS REDUCIDOS Y SERVICIO AJUSTADO ✅"
echo "========================================================"
echo "El log ahora solo registrará errores. El nivel es: --loglevel error."
