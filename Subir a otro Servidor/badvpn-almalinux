#!/bin/bash

# --- Script Integral y Optimizado para badvpn-udpgw (Multi-threaded) en AlmaLinux ---

echo "================================================================="
echo " INICIO: Instalación y Optimización de badvpn-udpgw (Multi-hilo) "
echo "================================================================="

# --- Variables de Configuración ---
SERVICE_FILE="/etc/systemd/system/badvpn-udpgw.service"
SYSCTL_CONF="/etc/sysctl.conf"
SSH_CONF="/etc/ssh/sshd_config"
MAX_CLIENTS=1000
MAX_CONNECTIONS=10

# Función para verificar si un comando tuvo éxito
check_status() {
    if [ $? -ne 0 ]; then
        echo "❌ ERROR: Falló el paso anterior. Abortando."
        exit 1
    fi
}

# --- 1. Preparación del Sistema y Detección de Núcleos ---
echo -e "\n--- 1. Preparando el sistema e instalando dependencias ---"
sudo dnf update -y
# Incluye dependencias de compilación y utilidades de sistema
sudo dnf install git cmake gcc make util-linux -y 
check_status

# Detección de núcleos para el parámetro --nthreads
NUM_CORES=$(nproc 2>/dev/null || lscpu -p | grep -c '^#$' || grep -c ^processor /proc/cpuinfo)
NUM_THREADS=${NUM_CORES}

if [ "$NUM_THREADS" -eq 0 ]; then
    echo "⚠️ ADVERTENCIA: No se pudo detectar el número de núcleos. Asignando 1 thread por defecto."
    NUM_THREADS=1
fi
echo "✅ Dependencias instaladas. Usando ${NUM_THREADS} threads para el servicio."

# --- 2. Descarga y Compilación del Fork Multi-threaded ---
echo -e "\n--- 2. Descargando y compilando el fork multi-threaded ---"
cd /opt

# Limpiar directorio antiguo si existe
if [ -d "badvpn" ]; then
    sudo rm -rf badvpn
fi

# Clonar un fork conocido que soporta --nthreads.
sudo git clone https://github.com/nrlquaker/badvpn.git badvpn
check_status

cd badvpn
sudo mkdir build
cd build
sudo cmake .. -DBUILD_NOTHING_BY_DEFAULT=1 -DBUILD_UDPGW=1
check_status
sudo make
check_status
sudo cp udpgw/badvpn-udpgw /usr/local/bin/
check_status
echo "✅ Compilación e instalación del binario multi-threaded completadas."

# --- 3. Creación y Configuración del Servicio Systemd ---
echo -e "\n--- 3. Creando el archivo de servicio Systemd optimizado ---"

# Nueva línea ExecStart con todos los parámetros: --nthreads, --max-clients, --loglevel error
NEW_EXEC_START="/usr/local/bin/badvpn-udpgw --loglevel error --listen-addr 127.0.0.1:7300 --nthreads ${NUM_THREADS} --max-clients ${MAX_CLIENTS} --max-connections-for-client ${MAX_CONNECTIONS}"

cat << EOF | sudo tee ${SERVICE_FILE}
[Unit]
Description=UDP Forwarder for badvpn-tun2socks
After=network.target

[Service]
ExecStart=${NEW_EXEC_START}
Restart=always
Type=simple

[Install]
WantedBy=multi-user.target
EOF
check_status

# Iniciar y habilitar el servicio
sudo systemctl daemon-reload
sudo systemctl enable badvpn-udpgw.service
sudo systemctl start badvpn-udpgw.service
check_status
echo "✅ Servicio badvpn-udpgw habilitado e iniciado."

# --- 4. Optimización del Kernel (sysctl) ---
echo -e "\n--- 4. Aplicando ajustes de red avanzados (sysctl) ---"

# Eliminar líneas optimizadas existentes para evitar duplicados
sudo sed -i '/^# Configuración optimizada para servidores SSH\/VPN/,/^vm.swappiness = 10/d' ${SYSCTL_CONF}

cat << EOF | sudo tee -a ${SYSCTL_CONF}
# Configuración optimizada para servidores SSH/VPN
net.ipv4.tcp_tw_reuse = 1
net.core.somaxconn = 65535
net.ipv4.tcp_fastopen = 3
net.core.default_qdisc = fq
net.ipv4.tcp_syncookies = 1
vm.swappiness = 10
EOF

sudo sysctl -p
check_status
echo "✅ Parámetros de sysctl actualizados y aplicados." 

# --- 5. Optimización del Servidor SSH (sshd_config) ---
echo -e "\n--- 5. Optimizando la configuración de SSH (sshd_config) ---"

# Desactivar compresión
sudo sed -i '/^Compression/d' ${SSH_CONF}
echo "Compression no" | sudo tee -a ${SSH_CONF} > /dev/null

# Usar cifrados modernos y rápidos
sudo sed -i '/^Ciphers/d' ${SSH_CONF}
sudo sed -i '/^KexAlgorithms/d' ${SSH_CONF}
echo "Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com" | sudo tee -a ${SSH_CONF} > /dev/null
echo "KexAlgorithms curve25519-sha256@libssh.org" | sudo tee -a ${SSH_CONF} > /dev/null

sudo systemctl restart sshd
check_status
echo "✅ Servicio SSH reiniciado con configuración optimizada."

# --- 6. Verificación de Estado Final ---
echo -e "\n========================================================="
echo "                 ✅ INSTALACIÓN COMPLETA Y FINAL ✅       "
echo "========================================================="
sudo systemctl status badvpn-udpgw.service
echo "  - badvpn-udpgw está configurado con ${NUM_THREADS} threads."
echo "  - Logs de bajo nivel desactivados (--loglevel error)."
echo "  - Límite de tráfico: ${MAX_CLIENTS} IPs y ${MAX_CONNECTIONS} conexiones/IP."
echo "========================================================="
