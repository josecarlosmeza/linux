#!/bin/bash

# =======================================================
#               CONFIGURACIÃ“N DEL SCRIPT
# =======================================================

DROPBEAR_VERSION="2024.84" 
NUEVA_VERSION_STRING="dropbear_REDLIBRE-3794776469" 
DROPBEAR_PORT="2222" 
PREFIX="/usr/local" 
BANNER_FILE="/etc/issue.net"

# Variables internas
TAR_FILE="dropbear-${DROPBEAR_VERSION}.tar.bz2"
SRC_DIR="dropbear-${DROPBEAR_VERSION}"
VERSION_FILE="version.h"
DROPBEAR_SBIN="${PREFIX}/sbin/dropbear"
DROPBEAR_BIN="${PREFIX}/bin/dropbearkey"
KEYS_DIR="${PREFIX}/etc"

# Comando de inicio: Solo RSA y Banner
RSA_KEY="${KEYS_DIR}/dropbear_rsa_host_key"
EXEC_COMMAND="${DROPBEAR_SBIN} -F -p ${DROPBEAR_PORT} -r ${RSA_KEY} -b ${BANNER_FILE}"

# =======================================================
#               PASOS DE INSTALACIÃ“N
# =======================================================

echo "--- ðŸ› ï¸ Iniciando InstalaciÃ³n Final de Dropbear (Seguridad/Shell Restringido) ---"

# 1. Instalar dependencias y Compilar (PAM habilitado)
echo "1. Instalando dependencias, compilando e instalando Dropbear (con soporte PAM)..."
sudo dnf install -y gcc make zlib-devel wget pam-devel
wget https://matt.ucc.asn.au/dropbear/releases/${TAR_FILE}
tar -xf ${TAR_FILE}
cd ${SRC_DIR}
sed -i "s|#define DROPBEAR_VERSION \"dropbear_${DROPBEAR_VERSION}\"|#define DROPBEAR_VERSION \"${NUEVA_VERSION_STRING}\"|g" ${VERSION_FILE}
./configure --prefix=${PREFIX} --enable-zlib --enable-pam
make
sudo make install

# 2. Generar y Limpiar Claves
echo "2. Generando claves de host..."
sudo mkdir -p ${KEYS_DIR}
sudo rm -f ${KEYS_DIR}/*host_key* ${KEYS_DIR}/*.pub
sudo ${DROPBEAR_BIN} -t rsa -f ${RSA_KEY}
sudo ${DROPBEAR_BIN} -t ed25519 -f ${KEYS_DIR}/dropbear_ed25519_host_key

# 3. Crear Banner
if [ ! -f "${BANNER_FILE}" ]; then
    echo "3. Creando archivo de banner..."
    sudo echo -e "========================================================\nADVERTENCIA: Acceso solo para transferencia de archivos. Sin Shell interactivo.\n========================================================" | sudo tee ${BANNER_FILE} > /dev/null
fi

# 4. Limpieza
cd ..
rm -rf ${SRC_DIR} ${TAR_FILE}

---
## âš™ï¸ ConfiguraciÃ³n de Seguridad (PAM y Shell Restringido)

# 5. Copiar configuraciÃ³n PAM de sshd
echo "5. Copiando configuraciÃ³n PAM de sshd a dropbear..."
sudo cp /etc/pam.d/sshd /etc/pam.d/dropbear

# 6. [CRÃTICO] Asegurar que /bin/false estÃ© en /etc/shells para permitir el inicio de sesiÃ³n restringido
echo "6. Verificando y aÃ±adiendo /bin/false a /etc/shells para seguridad..."
if ! grep -q '/bin/false' /etc/shells; then
    # AÃ±adimos /bin/false para que Dropbear lo reconozca como shell vÃ¡lido.
    echo "/bin/false" | sudo tee -a /etc/shells > /dev/null
    echo "   -> /bin/false ha sido aÃ±adido a /etc/shells."
else
    echo "   -> /bin/false ya estaba en /etc/shells."
fi

---
## ðŸ’¾ ConfiguraciÃ³n del Servicio (SYSTEMD)

# 7. Crear el archivo de servicio systemd
echo "7. Creando archivo de servicio systemd con el comando final corregido..."
sudo systemctl stop dropbear.service
SYSTEMD_SERVICE_FILE="/etc/systemd/system/dropbear.service"

sudo tee ${SYSTEMD_SERVICE_FILE} > /dev/null <<EOL
[Unit]
Description=Dropbear SSH Server (Custom Build)
After=network.target

[Service]
Type=simple
ExecStart=${EXEC_COMMAND}
Restart=always

[Install]
WantedBy=multi-user.target
EOL

# 8. Recargar y Iniciar Servicio
echo "8. Recargando, habilitando e iniciando el servicio Dropbear..."
sudo systemctl daemon-reload
sudo systemctl enable dropbear
sudo systemctl restart dropbear

# 9. Configurar Firewalld
echo "9. Configurando Firewalld (si estÃ¡ activo)..."
if sudo systemctl is-active firewalld >/dev/null; then
    sudo firewall-cmd --add-port=${DROPBEAR_PORT}/tcp --permanent
    sudo firewall-cmd --reload
fi

echo "======================================================="
echo "âœ… INSTALACIÃ“N FINAL Y COMPLETA."
echo "   - Ahora los usuarios con /bin/false deberÃ­an poder autenticarse (para SCP/SFTP) pero serÃ¡n rechazados de una shell interactiva."
echo "===================================
===================="
