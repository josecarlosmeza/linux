#!/bin/bash

# =======================================================
#               CONFIGURACIÃ“N DEL SCRIPT
# =======================================================

DROPBEAR_VERSION="2024.84" 
NUEVA_VERSION_STRING="dropbear_REDLIBRE-3794776469" 
DROPBEAR_PORT="2222" 
PREFIX="/usr/local" 
BANNER_FILE="/etc/issue.net"

# Variables internas
TAR_FILE="dropbear-${DROPBEAR_VERSION}.tar.bz2"
SRC_DIR="dropbear-${DROPBEAR_VERSION}"
VERSION_FILE="version.h"
DROPBEAR_SBIN="${PREFIX}/sbin/dropbear"
DROPBEAR_BIN="${PREFIX}/bin/dropbearkey"
KEYS_DIR="${PREFIX}/etc"

# Comando de inicio: Solo RSA y Banner
RSA_KEY="${KEYS_DIR}/dropbear_rsa_host_key"
EXEC_COMMAND="${DROPBEAR_SBIN} -F -p ${DROPBEAR_PORT} -r ${RSA_KEY} -b ${BANNER_FILE}"

# =======================================================
#               PASOS DE INSTALACIÃ“N
# =======================================================

echo "--- ðŸ› ï¸ Iniciando InstalaciÃ³n Final de Dropbear (Seguridad/Shell Restringido) ---"

#!/bin/bash

# =======================================================
#               CONFIGURACIÃ“N DEL SCRIPT
# =======================================================

DROPBEAR_VERSION="2024.84" 
NUEVA_VERSION_STRING="dropbear_MiServidorPrivado_v2024" 
DROPBEAR_PORT="2222" 
PREFIX="/usr/local" 
BANNER_FILE="/etc/issue.net"

# Variables internas
TAR_FILE="dropbear-${DROPBEAR_VERSION}.tar.bz2"
SRC_DIR="dropbear-${DROPBEAR_VERSION}"
VERSION_FILE="version.h"
DROPBEAR_SBIN="${PREFIX}/sbin/dropbear"
KEYS_DIR="${PREFIX}/etc"

# Comando de inicio CORREGIDO: SE ELIMINA LA OPCIÃ“N INVÃLIDA -v
RSA_KEY="${KEYS_DIR}/dropbear_rsa_host_key"
EXEC_COMMAND="${DROPBEAR_SBIN} -F -p ${DROPBEAR_PORT} -r ${RSA_KEY} -b ${BANNER_FILE}"

# =======================================================
#               PASOS DE INSTALACIÃ“N Y COMPILACIÃ“N
# =======================================================

echo "--- ðŸ› ï¸ Dropbear: Iniciando InstalaciÃ³n Completa (CompilaciÃ³n y Servicio Corregidos) ---"

# Limpieza de intentos anteriores
sudo rm -rf ${SRC_DIR} ${TAR_FILE}

# 1. Instalar dependencias y Compilar (PAM habilitado)
echo "1. Instalando dependencias, compilando e instalando Dropbear (con soporte PAM)..."
sudo dnf install -y gcc make zlib-devel wget pam-devel || { echo "ERROR: FallÃ³ la instalaciÃ³n de dependencias. Saliendo."; exit 1; }

wget https://matt.ucc.asn.au/dropbear/releases/${TAR_FILE} || { echo "ERROR: FallÃ³ la descarga de Dropbear. Saliendo."; exit 1; }
tar -xf ${TAR_FILE}
cd ${SRC_DIR} || { echo "ERROR: No se pudo acceder al directorio fuente. Saliendo."; exit 1; }

# Cambiar la cadena de versiÃ³n
sed -i "s|#define DROPBEAR_VERSION \"dropbear_${DROPBEAR_VERSION}\"|#define DROPBEAR_VERSION \"${NUEVA_VERSION_STRING}\"|g" ${VERSION_FILE}

# Configurar con PAM y Zlib
./configure --prefix=${PREFIX} --enable-zlib --enable-pam

# === CORRECCIÃ“N DE VINCULACIÃ“N: Rutas y librerÃ­as explÃ­citas para libpam ===
echo "-> Ejecutando 'make' con vinculaciÃ³n explÃ­cita a libpam..."
make LDFLAGS="-L/usr/lib64 -L/lib64 -lpam" || { echo "ERROR: FallÃ³ la compilaciÃ³n o vinculaciÃ³n (make). Revisar log."; exit 1; }
# ===========================================================================

sudo make install

# 2. Generar y Limpiar Claves
echo "2. Generando claves de host..."
sudo mkdir -p ${KEYS_DIR}
sudo rm -f ${KEYS_DIR}/*host_key* ${KEYS_DIR}/*.pub
sudo ${PREFIX}/bin/dropbearkey -t rsa -f ${RSA_KEY}
sudo ${PREFIX}/bin/dropbearkey -t ed25519 -f ${KEYS_DIR}/dropbear_ed25519_host_key

# 3. Crear Banner
if [ ! -f "${BANNER_FILE}" ]; then
    echo "3. Creando archivo de banner..."
    sudo echo -e "========================================================\nADVERTENCIA: Acceso solo para transferencia de archivos. Sin Shell interactivo.\n========================================================" | sudo tee ${BANNER_FILE} > /dev/null
fi

# 4. Limpieza de fuentes
cd ..
rm -rf ${SRC_DIR} ${TAR_FILE}

# === CORRECCIÃ“N DE PERMISOS SELINUX (Por si acaso) ===
echo "4b. Restableciendo contextos SELinux para binarios y claves..."
sudo restorecon -R -v /usr/local/sbin/dropbear
sudo restorecon -R -v /usr/local/etc/
sudo restorecon -R -v /etc/issue.net

---

## âš™ï¸ ConfiguraciÃ³n de Seguridad y PAM

# 5. [CRÃTICO] ConfiguraciÃ³n de PAM para Dropbear
echo "5. Configurando /etc/pam.d/dropbear (LÃ­mites, Audit y Unix auth)..."
sudo tee /etc/pam.d/dropbear > /dev/null <<EOL
#%PAM-1.0
auth       required     pam_unix.so shadow nullok
account    required     pam_unix.so
session    required     pam_limits.so      # Habilita lectura de limits.conf
session    required     pam_loginuid.so    # Soporte UID para auditorÃ­a
session    optional     pam_systemd.so     # Soporte de UUID de sesiÃ³n
session    required     pam_unix.so
EOL

# 6. Asegurar /bin/false estÃ© en /etc/shells
echo "6. Verificando y aÃ±adiendo /bin/false a /etc/shells..."
if ! grep -q '/bin/false' /etc/shells; then
    echo "/bin/false" | sudo tee -a /etc/shells > /dev/null
    echo "   -> /bin/false ha sido aÃ±adido a /etc/shells."
fi

---
## ðŸ’¾ ConfiguraciÃ³n del Servicio (SYSTEMD)

# 7. Crear el archivo de servicio systemd
echo "7. Creando archivo de servicio systemd para Dropbear..."
sudo systemctl stop dropbear.service
SYSTEMD_SERVICE_FILE="/etc/systemd/system/dropbear.service"

# === CORRECCIÃ“N: EjecStart utiliza la variable EXEC_COMMAND sin el -v invÃ¡lido ===
sudo tee ${SYSTEMD_SERVICE_FILE} > /dev/null <<EOL
[Unit]
Description=Dropbear SSH Server (Custom Build)
After=network.target

[Service]
Type=simple
ExecStart=${EXEC_COMMAND}
Restart=always

[Install]
WantedBy=multi-user.target
EOL

# 8. Recargar y Iniciar Servicio
echo "8. Recargando, habilitando e iniciando el servicio Dropbear..."
sudo systemctl daemon-reload
sudo systemctl enable dropbear
sudo systemctl restart dropbear

# 9. Configurar Firewalld
echo "9. Configurando Firewalld (si estÃ¡ activo) para puerto ${DROPBEAR_PORT}..."
if sudo systemctl is-active firewalld >/dev/null; then
    sudo firewall-cmd --add-port=${DROPBEAR_PORT}/tcp --permanent
    sudo firewall-cmd --reload
    echo "   -> Puerto ${DROPBEAR_PORT} abierto en Firewalld."
fi

echo "======================================================="
echo "âœ… Ã‰XITO: INSTALACIÃ“N Y SERVICIO CORREGIDOS."
echo "   Servicio Dropbear activo en puerto: ${DROPBEAR_PORT}"
echo "   Verifique el estado: sudo systemctl status dropbear"
echo "======================================================="
