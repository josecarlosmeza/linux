#!/bin/bash

# 1. Directorio y Script con GuÃ­a de ConfiguraciÃ³n
mkdir -p /opt/advanced-proxy
cat <<EOF > /opt/advanced-proxy/proxy.py
import asyncio, hashlib, base64

# ==============================================================================
# ðŸ“± CONFIGURACIÃ“N PARA HTTP CUSTOM (COPIA ESTO)
# ==============================================================================
# [Ajustes de SSH]
# SSH Host: [Tu_IP_o_Dominio_CloudFront]
# SSH Port: 80 (o 443)
# User/Pass: [Tus credenciales de Root o Usuario SSH]
# 
# [Payload]
# GET / HTTP/1.1[crlf]Host: [Tu_Dominio_CloudFront][crlf]Upgrade: websocket[crlf]Connection: Upgrade[crlf]X-Pass: mi_password_secreto[crlf][crlf]
#
# [Ajustes Adicionales]
# âœ… SSL (TLS): DESACTIVADO (El proxy es HTTP puro)
# âœ… Auto-Ping: 20 Segundos (Obligatorio para CloudFront)
# ==============================================================================

# CONFIGURACIÃ“N DEL SCRIPT
LISTENING_ADDR = '0.0.0.0'
PORTS = [80, 443]
PASS = 'mi_password_secreto'  # Debe coincidir con X-Pass del Payload
DEFAULT_TARGET = ('127.0.0.1', 22)

def generate_ws_accept(key):
    GUID = b"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"
    sha1 = hashlib.sha1(key + GUID).digest()
    return base64.b64encode(sha1).decode()

def find_header(head, header):
    try:
        start = head.lower().find(header.lower() + b': ')
        if start == -1: return b''
        start += len(header) + 2
        end = head.find(b'\r\n', start)
        return head[start:end].strip()
    except: return b''

async def forward(reader, writer):
    try:
        while True:
            try:
                data = await asyncio.wait_for(reader.read(4096), timeout=25)
                if not data: break
                writer.write(data)
                await writer.drain()
            except asyncio.TimeoutError:
                writer.write(b'\x00') # Keep-alive
                await writer.drain()
    except: pass
    finally:
        try: writer.close()
        except: pass

async def handle(client_reader, client_writer):
    try:
        data = await asyncio.wait_for(client_reader.read(4096), timeout=10)
        if not data: return
        
        passwd = find_header(data, b'X-Pass').decode('latin-1')
        if PASS and passwd != PASS:
            client_writer.write(b"HTTP/1.1 403 Forbidden\r\n\r\n")
            await client_writer.drain()
            return

        ws_key = find_header(data, b'Sec-WebSocket-Key')
        accept_val = generate_ws_accept(ws_key) if ws_key else "AnyValue"
        
        target_reader, target_writer = await asyncio.open_connection(*DEFAULT_TARGET)
        
        resp = ("HTTP/1.1 101 Switching Protocols\r\n"
                "Upgrade: websocket\r\n"
                "Connection: Upgrade\r\n"
                "Sec-WebSocket-Accept: %s\r\n"
                "Server: nginx/1.24.0\r\n\r\n" % accept_val).encode('latin-1')
        
        client_writer.write(resp)
        await client_writer.drain()

        await asyncio.gather(
            forward(client_reader, target_writer),
            forward(target_reader, client_writer)
        )
    except: pass
    finally:
        try: client_writer.close()
        except: pass

async def start_servers():
    tasks = [asyncio.start_server(handle, LISTENING_ADDR, p) for p in PORTS]
    servers = await asyncio.gather(*tasks)
    await asyncio.gather(*[s.serve_forever() for s in servers])

if __name__ == '__main__':
    try:
        asyncio.run(start_servers())
    except KeyboardInterrupt:
        pass
EOF

# 2. ConfiguraciÃ³n de Systemd
cat <<EOF > /etc/systemd/system/adv-proxy.service
[Unit]
Description=Advanced MultiPort Proxy SSHD
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/advanced-proxy
ExecStart=/usr/bin/python3 /opt/advanced-proxy/proxy.py
Restart=always
RestartSec=3
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

# 3. Aplicar y Reiniciar
systemctl daemon-reload
systemctl enable adv-proxy
systemctl restart adv-proxy

echo "âœ… Instalado. Abre /opt/advanced-proxy/proxy.py para ver tu Payload."
