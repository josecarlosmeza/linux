#!/bin/bash

# 1. Crear directorio de trabajo
mkdir -p /opt/advanced-proxy
cd /opt/advanced-proxy

# 2. Crear el script de Python optimizado para m√∫ltiples puertos
cat <<EOF > /opt/advanced-proxy/proxy.py
import asyncio, hashlib, base64

# =================================================================
# üõ†Ô∏è CONFIGURACI√ìN
# =================================================================
LISTENING_ADDR = '0.0.0.0'
PORTS = [80, 443]                 # Puertos de escucha simult√°nea
PASS = 'mi_password_secreto'      # Contrase√±a para X-Pass
DEFAULT_TARGET = ('127.0.0.1', 444) # Destino (Dropbear SSH)

# =================================================================
# GET / HTTP/1.1[crlf]Host: usa.grabados.store[crlf]Upgrade: websocket[crlf]Connection: Upgrade[crlf]Sec-WebSocket-Key: [key][crlf]X-Pass: mi_password_secreto[crlf][crlf]

# =================================================================
# ‚öôÔ∏è L√ìGICA DEL SISTEMA
# =================================================================

def generate_ws_accept(key):
    GUID = b"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"
    sha1 = hashlib.sha1(key + GUID).digest()
    return base64.b64encode(sha1).decode()

def find_header(head, header):
    try:
        start = head.lower().find(header.lower() + b': ')
        if start == -1: return b''
        start += len(header) + 2
        end = head.find(b'\r\n', start)
        return head[start:end].strip()
    except: return b''

async def forward(reader, writer):
    try:
        while True:
            data = await reader.read(4096)
            if not data: break
            writer.write(data)
            await writer.drain()
    except: pass
    finally:
        try: writer.close()
        except: pass

async def handle(client_reader, client_writer):
    try:
        # Leer cabecera inicial con timeout para evitar conexiones fantasma
        data = await asyncio.wait_for(client_reader.read(4096), timeout=10)
        if not data: return
        
        # Validaci√≥n de seguridad X-Pass
        passwd = find_header(data, b'X-Pass').decode('latin-1')
        if PASS and passwd != PASS:
            client_writer.write(b"HTTP/1.1 403 Forbidden\r\n\r\n")
            await client_writer.drain()
            return

        # Generar handshake WebSocket v√°lido
        ws_key = find_header(data, b'Sec-WebSocket-Key')
        accept_val = generate_ws_accept(ws_key) if ws_key else "AnyValue"
        
        # Conexi√≥n al servicio SSH local
        target_reader, target_writer = await asyncio.open_connection(*DEFAULT_TARGET)
        
        # Respuesta HTTP 101 optimizada para CDNs
        resp = ("HTTP/1.1 101 Switching Protocols\r\n"
                "Upgrade: websocket\r\n"
                "Connection: Upgrade\r\n"
                "Sec-WebSocket-Accept: %s\r\n"
                "Server: nginx/1.24.0\r\n\r\n" % accept_val).encode('latin-1')
        
        client_writer.write(resp)
        await client_writer.drain()

        # Iniciar intercambio de datos bidireccional
        await asyncio.gather(
            forward(client_reader, target_writer),
            forward(target_reader, client_writer)
        )
    except: pass
    finally:
        try: client_writer.close()
        except: pass

async def start_servers():
    tasks = []
    for port in PORTS:
        print(f"üöÄ Iniciando servidor en puerto {port}...")
        try:
            server = await asyncio.start_server(handle, LISTENING_ADDR, port)
            tasks.append(server.serve_forever())
        except Exception as e:
            print(f"‚ùå Error al abrir puerto {port}: {e}")
    
    if tasks:
        await asyncio.gather(*tasks)
    else:
        print("üî¥ No se pudo iniciar ning√∫n puerto. Verifica si est√°n ocupados.")

def main():
    loop = asyncio.get_event_loop()
    try:
        loop.run_until_complete(start_servers())
    except KeyboardInterrupt:
        pass
    finally:
        loop.close()

if __name__ == '__main__':
    main()
EOF

# 3. Crear el archivo de servicio para Systemd
cat <<EOF > /etc/systemd/system/adv-proxy.service
[Unit]
Description=Advanced Multi-Port HTTP Proxy
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/advanced-proxy
ExecStart=/usr/bin/python3 /opt/advanced-proxy/proxy.py
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# 4. Configurar Firewall (Abrir puertos 80 y 443)
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --reload

# 5. Habilitar y arrancar el servicio
systemctl daemon-reload
systemctl enable adv-proxy
systemctl restart adv-proxy

echo "------------------------------------------------"
echo "‚úÖ Instalaci√≥n completada."
echo "‚úÖ Puertos activos: 80 y 443 (HTTP Puro)"
echo "‚úÖ Redirigiendo a Dropbear en 127.0.0.1:444"
echo "------------------------------------------------"
systemctl status adv-proxy --no-pager
