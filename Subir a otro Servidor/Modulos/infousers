#!/bin/bash

# Limpiar pantalla y mostrar lista general
clear
echo -e "\E[44;1;37m Usuario         Contraseña       Limite      Valides \E[0m"
echo ""

# Lista General
for users in $(awk -F : '$3 >= 1000 { print $1 }' /etc/passwd | sort | grep -v "nobody")
do
    # Lógica de Límite
    [[ $(grep -cw "$users" $HOME/usuarios.db) == "1" ]] && lim=$(grep -w "$users" $HOME/usuarios.db | cut -d' ' -f2) || lim="1"

    # Lógica de Contraseña
    [[ -e "/etc/RedLibre/senha/$users" ]] && senha=$(cat "/etc/RedLibre/senha/$users") || senha="Null"

    # Conteo de procesos del usuario
    conexiones=$(ps -u "$users" | grep -c sshd)

    # Lógica de Fecha
    datauser=$(chage -l "$users" | grep -i "Account expires" | cut -d: -f2 | xargs)
    if [[ "$datauser" == "never" || "$datauser" == "nunca" || -z "$datauser" ]]; then
        data="\033[1;33mNunca\033[0m"
    else
        databr=$(date -d "$datauser" +"%Y%m%d" 2>/dev/null)
        hoje=$(date +"%Y%m%d")
        if [ "$hoje" -ge "$databr" ] 2>/dev/null; then
            data="\033[1;31mVenceu\033[0m"
        else
            dat="$(date -d "$datauser" '+%Y-%m-%d')"
            data=$(echo -e "$((($(date -ud $dat +%s)-$(date -ud $(date +%Y-%m-%d) +%s))/86400)) \033[1;37mDias\033[0m")
        fi
    fi

    # Formateo visual
    if [[ "$conexiones" -gt "0" ]]; then
        Usuario=$(printf ' %-15s' "$users ($conexiones)")
    else
        Usuario=$(printf ' %-15s' "$users")
    fi
    
    Senha=$(printf '%-13s' "$senha")
    Limite=$(printf '%-10s' "$lim")
    Data=$(printf '%-1s' "$data")

    echo -e "\033[1;33m$Usuario \033[1;37m$Senha \033[1;37m$Limite \033[1;32m$Data\033[0m"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
done

# Resumen inferior
_tuser=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
_onli=$(ps aux | grep sshd | grep -v root | grep -v grep | wc -l)
echo -e "\n\033[1;33m• \033[1;36mTOTAL USUARIOS:\033[1;37m $_tuser  \033[1;33m• \033[1;32mVPN ONLINE:\033[1;37m $_onli \033[1;33m•\033[0m\n"

# --- SECCIÓN DE INTERACCIÓN ---
echo -ne "\033[1;37mEscriba un nombre para detalles o [\033[1;32mEnter\033[1;37m] para salir: \033[1;33m"
read -r selection

if [[ -n "$selection" ]]; then
    if id "$selection" >/dev/null 2>&1; then
        clear
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo -e "\E[44;1;37m        DETALLES DE CONEXIÓN VPN: $selection      \E[0m"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        
        # Conteo y Tiempo de conexión
        d_conexiones=$(ps -u "$selection" -o comm,etime | grep sshd | awk '{print $2}')
        num_con=$(echo "$d_conexiones" | wc -w)
        
        if [[ $num_con -gt 0 ]]; then
            d_estado="\033[1;32mCONECTADO\033[0m"
            # Formatear lista de tiempos si hay varias sesiones
            tiempos=$(echo "$d_conexiones" | xargs | sed 's/ / | /g')
        else
            d_estado="\033[1;31mDESCONECTADO\033[0m"
            tiempos="N/A"
        fi

        [[ -e /etc/RedLibre/senha/$selection ]] && d_pass=$(cat /etc/RedLibre/senha/$selection) || d_pass="Null"
        d_val=$(chage -l "$selection" | grep -i "Account expires" | cut -d: -f2 | xargs)
        
        echo -e "\033[1;36m USUARIO:     \033[1;37m$selection"
        echo -e "\033[1;36m ESTADO VPN:  $d_estado"
        echo -e "\033[1;36m SESIONES:    \033[1;37m$num_con activa(s)"
        echo -e "\033[1;36m TIEMPO/S:    \033[1;33m$tiempos (H:M:S)"
        echo -e "\033[1;36m CONTRASEÑA:  \033[1;37m$d_pass"
        echo -e "\033[1;36m VENCIMIENTO: \033[1;37m$d_val"
        echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
        echo ""
        read -p "Presione [Enter] para salir..."
    else
        echo -e "\n\033[1;31mError: El usuario '$selection' no existe.\033[0m"
        sleep 2
    
    fi
fi
clear
