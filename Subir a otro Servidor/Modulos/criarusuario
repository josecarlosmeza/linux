#!/bin/bash
#====================================================
#   SCRIPT: CREAR USUARIO SSH (DISEÑO VERTICAL)
#   OPTIMIZADO PARA: ALMALINUX
#====================================================

# Instalación de dependencias
for pkg in perl curl; do
    command -v $pkg >/dev/null 2>&1 || dnf install -y $pkg
done

# Directorios de base de datos
[[ ! -d /etc/RedLibre/senha ]] && mkdir -p /etc/RedLibre/senha
[[ ! -f /root/usuarios.db ]] && touch /root/usuarios.db

clear
tput setaf 7; tput setab 4; tput bold; printf '%30s%s%-15s\n' "Crear Usuario SSH"; tput sgr0
echo ""

# --- Entrada de Datos ---
echo -ne "\033[1;32mNombre de usuario:\033[1;37m "; read username
if id "$username" &>/dev/null; then
    echo -e "\n\033[41;1;37m Error: ¡El usuario ya existe! \033[0m\n"
    exit 1
fi

echo -ne "\033[1;32mContraseña:\033[1;37m "; read password
echo -ne "\033[1;32mDías de validez:\033[1;37m "; read dias
echo -ne "\033[1;32mLímite de conexiones:\033[1;37m "; read sshlimiter

# Cálculos de fechas y horas
final=$(date "+%Y-%m-%d" -d "+$dias days")
gui=$(date "+%d/%m/%Y" -d "+$dias days")
hora_cambio=$(date "+%H:%M:%S")

# Creación del usuario (AlmaLinux)
pass=$(perl -e 'print crypt($ARGV[0], "password")' "$password")
useradd -e "$final" -M -s /bin/false -p "$pass" "$username" >/dev/null 2>&1

# Registro interno
echo "$password" > "/etc/RedLibre/senha/$username"
echo "$username $sshlimiter" >> /root/usuarios.db

# --- RESULTADOS (UNA LÍNEA POR DATO) ---
clear
echo -e "\033[1;32m¡ÉXITO! PROCESO COMPLETADO\033[0m"
echo ""
echo -e "\033[1;37mUsuario: \033[1;32m$username\033[0m"
echo -e "\033[1;37mContraseña: \033[1;32m$password\033[0m"
echo -e "\033[1;37mLímite de conexiones: \033[1;32m$sshlimiter\033[0m"
echo -e "\033[1;37mFecha de vencimiento: \033[1;33m$gui\033[0m"
echo -e "\033[1;37mHora de corte (aprox): 00:00:01 AM\033[0m"
echo -e "\033[1;37mCambio realizado a las: $hora_cambio\033[0m"
echo ""
echo -e "\033[1;37mCódigo de acceso: \033[1;32m$username:$password\033[0m"
echo ""
echo -ne "\033[1;33mPresione [ENTER] para volver a la consola...\033[0m"
read
