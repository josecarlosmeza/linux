#!/bin/bash
# Script: dropbear_watcher.sh
database="/root/usuarios.db"
AUTH_LOG_FILE="/var/log/secure"
LOG_KILL_FILE="/var/log/session_kill.log"

get_active_session_count() {
    local target_user=$1
    local active_count=0
    SUCCESS_LINES=$(grep -E 'Accepted password|Password auth succeeded|session opened' "$AUTH_LOG_FILE" | grep -w "$target_user")

    if [[ -n "$SUCCESS_LINES" ]]; then
        local pids=""
        pids+=$(echo "$SUCCESS_LINES" | grep "dropbear" | sed -E 's/.*dropbear\[([0-9]+)\].*/\1/')
        pids+=" "
        pids+=$(echo "$SUCCESS_LINES" | grep "sshd" | sed -E 's/.*sshd\[([0-9]+)\].*/\1/')
        REGISTERED_PIDS=$(echo "$pids" | tr ' ' '\n' | grep -v '^$' | sort -u)

        for pid in $REGISTERED_PIDS; do
            if ps -p "$pid" > /dev/null 2>&1; then
                active_count=$((active_count + 1))
            fi
        done
    fi
    echo "$active_count"
}

while true; do
    while IFS=' ' read -r user s2ssh _ 
    do  
        user=$(echo "$user" | xargs)
        s2ssh=$(echo "$s2ssh" | xargs)
        
        if [[ -z "$s2ssh" || "$s2ssh" -eq 0 ]]; then
            continue
        fi

        CURRENT_SESSIONS=$(get_active_session_count "$user")
        
        if [[ "$CURRENT_SESSIONS" -gt "$s2ssh" ]]; then
            
            # Obtener TODOS los PIDs activos (ordenados de m치s nuevo a m치s viejo)
            ALL_ACTIVE_PIDS=$(
                grep -E 'Accepted password|Password auth succeeded|session opened' "$AUTH_LOG_FILE" | 
                grep -w "$user" | 
                sed -E -e '/dropbear/! s/.*sshd\[([0-9]+)\].*/\1/g' -e '/sshd/! s/.*dropbear\[([0-9]+)\].*/\1/g' |
                tr -s ' ' '\n' | grep -v '^$' | sort -nr | # sort -nr da el PID m치s reciente
                while read pid; do
                    ps -p $pid >/dev/null 2>&1 && echo "$pid"
                done
            )
            
            # PID a matar: El m치s reciente activo (el primero en la lista)
            PID_TO_KILL=$(echo "$ALL_ACTIVE_PIDS" | head -1)

            if [[ -n "$PID_TO_KILL" ]]; then
                kill "$PID_TO_KILL" 2>/dev/null
                echo "$(date): KILLED PID $PID_TO_KILL for user $user. Limit exceeded ($CURRENT_SESSIONS/$s2ssh)" >> "$LOG_KILL_FILE"
            fi
        fi
        
    done < "$database"
    
    sleep 
5
done
