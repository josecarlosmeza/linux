#!/bin/bash
# Ubicación: /usr/bin/sshmonitor
database="/root/usuarios.db"
clear
echo -e "\E[44;1;37m Usuario        Estado        Conexión        Tiempo   \E[0m"
echo ""
TOTAL_SESSIONS=0
while IFS=' ' read -r user limit _
do
    # Ignorar comentarios y líneas vacías
    [[ -z "$user" || "$user" == "#"* || "$user" == "*" ]] && continue
    user="${user//[[:space:]]/}"
    limit="${limit//[[:space:]]/}"
    # --- CONTEO POR PROCESOS REALES ---
    # Buscamos procesos sshd que pertenezcan al usuario
    pids=$(pgrep -u "$user" sshd)
    if [ -z "$pids" ]; then
        # OFFLINE
        session_count=0
        status=$(echo -e "\033[1;31mOffline \033[1;33m       ")
        timerr="00:00:00"
    else
        # ONLINE
        session_count=$(echo "$pids" | wc -l)
        TOTAL_SESSIONS=$((TOTAL_SESSIONS + session_count))
        # Obtener tiempo del proceso más antiguo
        oldest_pid=$(echo "$pids" | sort -n | head -n 1)
        timerr=$(ps -o etime= -p "$oldest_pid" | tr -d '[:space:]')
        status=$(echo -e "\033[1;32mOnline\033[1;33m         ")
    fi
    # Formatear salida
    echo -ne "\033[1;33m"
    printf '%-17s%-14s%-10s%s\n' " $user" "$status" "$session_count/$limit" "$timerr"
    echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
done < "$database"
echo -e "\n\E[44;1;37m Sesiones Totales Activas: $TOTAL_SESSIONS \E[0m\n"
