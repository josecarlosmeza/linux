#!/bin/bash
clear
backbot=$1
[[ -z $backbot ]] && {
	IP=$(wget -qO- ipv4.icanhazip.com)
	apchon () {
		_webok=
		command -v ss &>/dev/null && _webok=$(ss -nltp 2>/dev/null | grep -E 'dropbear|:80') || _webok=$(netstat -nltp 2>/dev/null | grep -E 'dropbear|:80')
		[[ ! -d /var/www/html ]] && mkdir -p /var/www/html
		[[ ! -d /var/www/html/backup ]] && mkdir -p /var/www/html/backup
		touch /var/www/html/backup/index.html
		if command -v systemctl &>/dev/null && systemctl is-active --quiet httpd 2>/dev/null; then
			systemctl restart httpd 2>/dev/null
		elif [[ -x /etc/init.d/apache2 ]]; then
			[[ -n "$_webok" ]] || (command -v apt-get &>/dev/null && apt-get install -y apache2 zip 2>/dev/null; sed -i "s/Listen 80/Listen 81/g" /etc/apache2/ports.conf 2>/dev/null)
			/etc/init.d/apache2 restart 2>/dev/null
		elif command -v dnf &>/dev/null; then
			dnf install -y httpd zip 2>/dev/null
			chmod -R 755 /var/www 2>/dev/null
			systemctl enable --now httpd 2>/dev/null
		else
			apt-get install -y apache2 zip 2>/dev/null
			sed -i "s/Listen 80/Listen 81/g" /etc/apache2/ports.conf 2>/dev/null
			service apache2 restart 2>/dev/null
		fi
		chmod -R 755 /var/www 2>/dev/null || true
	}
	fun_temp () {
		helice () {
			apchon > /dev/null 2>&1 & 
			tput civis
			while [ -d /proc/$! ]
			do
				for i in / - \\ \|
				do
					sleep .1
					echo -ne "\e[1D$i"
				done
			done
			tput cnorm
		}
		echo -ne "\033[1;33mAGUARDE\033[1;31m.\033[1;32m.\033[1;33m. \033[1;32m"
		helice
		echo -e "\e[1DOk"
	}
	geralink () {
		if [ -d /var/www/html/backup ]; then
			rm -rf /var/www/html/backup/backup.vps > /dev/null 2>&1
			cp $HOME/backup.vps /var/www/html/backup/backup.vps
			sleep 2
		fi
	}
	fun_temp2 () {
		helice () {
			geralink > /dev/null 2>&1 & 
			tput civis
			while [ -d /proc/$! ]
			do
				for i in / - \\ \|
				do
					sleep .1
					echo -ne "\e[1D$i"
				done
			done
			tput cnorm
		}
		echo -ne "\033[1;33mGERANDO LINK\033[1;31m.\033[1;32m.\033[1;33m. \033[1;32m"
		helice
		echo -e "\e[1DOk"
	}
	echo -e "\E[44;1;37m             Gerenciador De Backups              \E[0m"
	echo ""
	echo -e "\033[1;31m[\033[1;36m1\033[1;31m] \033[1;37m• \033[1;33mCRIAR BACKUP"
	echo -e "\033[1;31m[\033[1;36m2\033[1;31m] \033[1;37m• \033[1;33mRESTAURAR BACKUP"
	echo -e "\033[1;31m[\033[1;36m3\033[1;31m] \033[1;37m• \033[1;33mVOLTAR\033[1;37m"
	echo ""
	echo -ne "\033[1;32mOQUE DESEJA FAZER\033[1;31m ?\033[1;37m : "; read opcao
	if [[ "$opcao" = '1' ]]; then
		if [ -f "/root/usuarios.db" ]
		then
			rm -rf $HOME/backup.vps > /dev/null 2>&1
			sleep 1
			tar cvf /root/backup.vps /root/usuarios.db /etc/shadow /etc/passwd /etc/group /etc/gshadow > /dev/null 2>&1
			echo ""
			echo -e "\033[1;32mBACKUP CRIADO COM SUCESSO !\033[0m"
			echo ""
			echo -ne "\033[1;32mGERAR LINK PARA DOWNLOAD \033[1;31m? \033[1;33m[s/n]:\033[1;37m "; read resp
			if [[ "$resp" = "s" ]]; then
				echo ""
				fun_temp
				echo ""
				fun_temp2
				echo ""
				if [ -e /var/www/html/backup/backup.vps ]; then
					if [[ "$VERSION_ID" = 'VERSION_ID="14.04"' ]]; then
						echo -e "\033[1;32mLINK\033[1;37m: \033[1;36m$IP:81/html/backup/backup.vps\033[0m"
					else
						echo -e "\033[1;32mLINK\033[1;37m: \033[1;36m$IP:81/backup/backup.vps\033[0m"
					fi
				else
					echo -e "\033[1;32mDisponivel em\033[1;31m" ~/"backup.vps\033[0m"
				fi
			else
				echo -e "\n\033[1;32mDisponivel em\033[1;31m" ~/"backup.vps\033[0m"
				sleep 2
				menu
			fi
		else
			echo ""
			echo -e "\033[1;32mCriando backup...\033[0m"
			echo ""
			tar cvf /root/backup.vps /etc/shadow /etc/passwd /etc/group /etc/gshadow > /dev/null 2>&1
			sleep 2s
			echo ""
			echo -e "\033[1;33mO Arquivo \033[1;32mbackup.vps"
			echo -e "\033[1;33mfoi criado com sucesso no diretório \033[1;31m/root\033[0m"
			echo ""
		fi
	fi
	if [[ "$opcao" = '2' ]]; then
		if [ -f "/root/backup.vps" ]
		then
			echo ""
			echo -e "\033[1;36mRestaurando backup..."
			echo ""
			sleep 2s
			cp /root/backup.vps /backup.vps
			cd /
			tar -xvf backup.vps
			rm /backup.vps
			echo ""
			echo -e "\033[1;36mUsuários e\033[1;36m senhas importados com sucesso.\033[0m"
			echo ""
			exit
		else
			echo ""
			echo -e "\033[1;33mO arquivo \033[1;32mbackup.vps \033[1;33mnão foi encontrado!\033[0m"
			echo -e "\033[1;33mCeritifique-se que ele esteja localizado no diretório /root/ com o nome \033[1;32mbackup.vps\033[0m"
			echo ""
			exit
		fi
	fi
	if [[ "$opcao" = '3' ]]; then
		menu
	fi
} || {
	rm /root/backup.vps 1>/dev/null 2>/dev/null
	tar cvf /root/backup.vps /root/usuarios.db /etc/shadow /etc/passwd /etc/group /etc/gshadow /etc/bot 1>/dev/null 2>/dev/null
	[[ -d "/etc/RedLibre/backups" ]] && mv /root/backup.vps /etc/RedLibre/backups/backup.vps
	exit
}
