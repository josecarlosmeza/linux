#!/bin/bash

# Comprobar si es root
if [[ $EUID -ne 0 ]]; then
   echo -e "\033[1;31mError: Este script debe ejecutarse como root (sudo).\033[0m"
   exit 1
fi

# Limpiar pantalla inicial
clear

# Define el título y formato inicial
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%33s%s%-12s\n' "Modificar Fecha de Expiración" ;
tput sgr0
echo ""
echo -e "\033[1;33m LISTA DE USUARIOS Y ESTADO ACTUAL:\033[0m "
echo ""

tput setaf 7 ;
tput bold

# Coleta lista de usuarios válidos
list_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)

i=0
_userPass=""

while read user;
do
    [[ -z "$user" ]] && continue
    i=$((i + 1))
    _oP=$i
    
    if (( i < 10 )); then _idx_display="0$i"; else _idx_display="$i"; fi
    
    # Obtiene la fecha de expiración
    expire="$(LANG=en_US.UTF-8 chage -l "$user" | grep -E "Account expires" | cut -d ' ' -f3-)"
    
    if [[ $expire == "never" ]]
    then
        echo -e "\033[1;31m[\033[1;36m$_idx_display\033[1;31m] \033[1;37m- \033[1;32m$user     \033[1;33m00/00/0000   SIN FECHA\033[0m"
    else
        databr="$(date -d "$expire" +"%Y%m%d" 2>/dev/null)"
        hoje="$(date -d today +"%Y%m%d")"
        
        if [ "$hoje" -ge "$databr" ] 2>/dev/null
        then
            _user=$(echo -e "\033[1;31m[\033[1;36m$_idx_display\033[1;31m] \033[1;37m- \033[1;32m$user\033[1;37m")
            datanormal="$(echo -e "\033[1;31m$(date -d"$expire" '+%d/%m/%Y')")"
            expired=$(echo -e "\033[1;31mEXPIRADO\033[0m")
            printf '%-62s%-20s%s\n' "$_user" "$datanormal" "$expired"
        else
            _user=$(echo -e "\033[1;31m[\033[1;36m$_idx_display\033[1;31m] \033[1;37m- \033[1;32m$user\033[1;37m")
            datanormal="$(echo -e "\033[1;33m$(date -d"$expire" '+%d/%m/%Y')")"
            ative=$(echo -e "\033[1;32mVÁLIDO\033[0m")
            printf '%-62s%-20s%s\n' "$_user" "$datanormal" "$ative"
        fi
    fi
    _userPass="${_userPass}${_oP}:${user}\n"
done <<< "${list_user}"

tput sgr0
echo ""

# Selección de usuario
num_user=$i
echo -ne "\033[1;32mIngrese NOMBRE o NÚMERO de usuario \033[1;33m[\033[1;36m1\033[1;36m-$num_user\033[1;33m]\033[1;37m: " ;
read option

if [[ -z $option ]]; then exit 1; fi

if [[ $option =~ ^[0-9]+$ ]]; then
    usuario=$(echo -e "${_userPass}" | grep -w "^$option" | cut -d: -f2)
else
    usuario=$option
fi

if ! id "$usuario" >/dev/null 2>&1; then
    echo -e "\n\033[1;41m Error: El usuario '$usuario' no existe. \033[0m\n"
    exit 1
fi

# Mostrar datos actuales del usuario antes de configurar
expire_raw=$(LANG=en_US.UTF-8 chage -l "$usuario" 2>/dev/null | grep "Account expires" | awk -F': ' '{print $2}' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
echo ""
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[1;33m  DATOS ACTUALES DEL USUARIO: \033[1;32m$usuario\033[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
if [[ -z "$expire_raw" || "$expire_raw" == "never" ]]; then
    echo -e "\033[1;32m  Fecha de vencimiento: \033[1;37mSin fecha (nunca expira)\033[0m"
    echo -e "\033[1;32m  Días restantes:        \033[1;37m—\033[0m"
    echo -e "\033[1;32m  Estado:               \033[1;32mVÁLIDO\033[0m"
else
    fecha_venc=$(date --date="$expire_raw" '+%d/%m/%Y' 2>/dev/null || date -d "$expire_raw" '+%d/%m/%Y' 2>/dev/null)
    exp_sec=$(date +%s --date="$expire_raw" 2>/dev/null || date +%s -d "$expire_raw" 2>/dev/null)
    now_sec=$(date +%s)
    echo -e "\033[1;32m  Fecha de vencimiento: \033[1;37m$fecha_venc\033[0m"
    if [[ -n "$exp_sec" ]]; then
        if [[ $now_sec -ge $exp_sec ]]; then
            dias_rest=0
            echo -e "\033[1;32m  Días restantes:        \033[1;31m0 (expirado)\033[0m"
            echo -e "\033[1;32m  Estado:               \033[1;31mEXPIRADO\033[0m"
        else
            dias_rest=$(( (exp_sec - now_sec) / 86400 ))
            echo -e "\033[1;32m  Días restantes:        \033[1;37m$dias_rest días\033[0m"
            echo -e "\033[1;32m  Estado:               \033[1;32mVÁLIDO\033[0m"
        fi
    else
        echo -e "\033[1;32m  Días restantes:        \033[1;37m—\033[0m"
        echo -e "\033[1;32m  Estado:               \033[1;33m—\033[0m"
    fi
fi
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo ""
echo -e "\033[1;31mCONFIGURACIÓN DE TIEMPO:\033[0m"
echo -e "\033[1;32mEjemplos: \033[1;37m'30' (días) o '21/12/2025' (fecha específica)"
echo ""
echo -ne "\033[1;32mNueva fecha para \033[1;33m$usuario: \033[1;37m";
read inputdate

# Procesar entrada
if [[ $inputdate =~ ^[0-9]+$ ]]; then
    udata=$(date "+%d/%m/%Y" -d "+$inputdate days" 2>/dev/null)
    sysdate="$(date "+%Y-%m-%d" -d "+$inputdate days" 2>/dev/null)"
elif [[ $inputdate =~ ^[0-9]{2}/[0-9]{2}/[0-9]{4}$ ]]; then
    udata="$inputdate"
    sysdate="$(echo "$udata" | awk -v FS=/ -v OFS=- '{print $3,$2,$1}')"
else
    echo -e "\n\033[1;41m Formato inválido. \033[0m"
    exit 1
fi

# Validar fecha
if ! date -d "$sysdate" > /dev/null  2>&1; then
    echo -e "\n\033[1;41m Fecha inexistente. \033[0m"
    exit 1
fi

# Aplicar cambio
chage -E "$sysdate" "$usuario"

# Obtener la hora actual para el reporte
hora_vencimiento=$(date +"%H:%M:%S")

echo ""
tput setaf 7 ; tput setab 4 ; tput bold ;
echo " ¡ÉXITO! PROCESO COMPLETADO " ;
tput sgr0
echo -e "\033[1;32mUsuario: \033[1;37m$usuario"
echo -e "\033[1;32mFecha de vencimiento: \033[1;37m$udata"
echo -e "\033[1;32mHora de corte (aprox): \033[1;37m00:00:01 AM"
echo -e "\033[1;33mCambio realizado a las: \033[1;37m$hora_vencimiento"
echo ""

# --- PAUSA ANTES DE SALIR ---
echo -e "\033[1;33mPresione \033[1;32m[ENTER]\033[1;33m para volver a la consola...\033[0m"
read -r

exit 0
