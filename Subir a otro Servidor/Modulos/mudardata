#!/bin/bash

# Define el título y formato inicial
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%33s%s%-12s\n' "Modificar Fecha de Expiración" ;
tput sgr0
echo ""
echo -e "\033[1;33m LISTA DE USUARIOS Y FECHA DE EXPIRACIÓN:\033[0m "
echo ""

tput setaf 7 ;
tput bold

# Coleta lista de usuarios válidos
list_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)

i=0
unset _userPass

# Loop para listar usuarios y determinar el estado de expiración
while read user;
do
	i=$((i + 1)) # Incremento más moderno
	_oP=$i
	
	# Formata el índice para exhibición (01, 02, etc.)
	if (( i < 10 )); then
        _idx_display="0$i"
    else
        _idx_display="$i"
    fi
	
	# Obtiene la fecha de expiración
	expire="$(chage -l $user | grep -E "Account expires" | cut -d ' ' -f3-)"
	
	if [[ $expire == "never" ]]
	then
		# Caso: Nunca expira
		echo -e "\033[1;31m[\033[1;36m$_idx_display\033[1;31m] \033[1;37m- \033[1;32m$user     \033[1;33m00/00/0000   SIN FECHA\033[0m"
	else
		databr="$(date -d "$expire" +"%Y%m%d")"
		hoje="$(date -d today +"%Y%m%d")"
		
		if [ $hoje -ge $databr ]
		then
			# Caso: Expirado
			_user=$(echo -e "\033[1;31m[\033[1;36m$_idx_display\033[1;31m] \033[1;37m- \033[1;32m$user\033[1;37m")
			datanormal="$(echo -e "\033[1;31m$(date -d"$expire" '+%d/%m/%Y')")"
			expired=$(echo -e "\033[1;31mEXPIRADO\033[0m") # MENSAGEM ALTERADA
			printf '%-62s%-20s%s\n' "$_user" "$datanormal" "$expired"
			echo "exp" > /tmp/exp
		else
			# Caso: Válido (futuro)
			_user=$(echo -e "\033[1;31m[\033[1;36m$_idx_display\033[1;31m] \033[1;37m- \033[1;32m$user\033[1;37m")
			datanormal="$(echo -e "\033[1;33m$(date -d"$expire" '+%d/%m/%Y')")"
			ative=$(echo -e "\033[1;32mVÁLIDO\033[0m") # MENSAGEM ALTERADA
			printf '%-62s%-20s%s\n' "$_user" "$datanormal" "$ative"
		fi
	fi
	_userPass+="\n${_oP}:${user}"
done <<< "${list_user}"

tput sgr0
echo ""

if [ -a /tmp/exp ]
then
	rm /tmp/exp
fi

# Pide la selección del usuario
num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
echo -ne "\033[1;32mIngrese o seleccione un usuario \033[1;33m[\033[1;36m1\033[1;33m-\033[1;36m$num_user\033[1;33m]\033[1;37m: " ; # MENSAGEM ALTERADA
read option

# VALIDAÇÃO 1: Opción de usuario
if [[ -z $option || ! $option =~ ^[0-9]+$ ]]
then
	echo ""
	tput setaf 7 ; tput setab 1 ; tput bold ;
	echo "Error, Opción de usuario vacía o inválida (debe ser un número)." ; # MENSAGEM ALTERADA
	tput sgr0
	exit 1
fi

# Obtiene el nombre de usuario por el índice
usuario=$(echo -e "${_userPass}" | grep -E "\b$option\b" | cut -d: -f2)

# VALIDAÇÃO 2: Usuário válido no mapeamento
if [[ -z $usuario ]]
then
	echo ""
	tput setaf 7 ;
	tput setab 1 ; tput bold ; echo "Error, Opción de usuario vacía o inválida!!!" ; # MENSAGEM ALTERADA
	tput sgr0
	echo ""
	exit 1
fi

# VALIDAÇÃO 3: Usuário existe no sistema
if grep -q "^$usuario:" /etc/passwd
then
    echo ""
    echo -e "\033[1;31mEJEMPLO:\033[1;33m(\033[1;32mFECHA: \033[1;37mDÍA/MES/AÑO \033[1;33mO \033[1;32mDÍAS: \033[1;37m30\033[1;33m)" # MENSAGEM ALTERADA
    echo ""
    echo -ne "\033[1;32mNueva fecha o días para el usuario \033[1;33m$usuario: \033[1;37m"; # MENSAGEM ALTERADA
    read inputdate

    # VALIDAÇÃO DE ENTRADA E CONVERSÃO
    if [[ $inputdate =~ ^[0-9]+$ ]]; then
        # Entrada como DIAS (e.g., 30)
        udata=$(date "+%d/%m/%Y" -d "+$inputdate days" 2>/dev/null)
    elif [[ $inputdate =~ ^[0-9]{2}/[0-9]{2}/[0-9]{4}$ ]]; then
        # Entrada como DATA (e.g., 21/04/2018)
        udata="$inputdate"
    else
        # Entrada Inválida
        echo ""
        tput setaf 7 ; tput setab 1 ; tput bold ;	
        echo "Ingresó una fecha o formato inválido o inexistente." ; # MENSAGEM ALTERADA
        echo "Ingrese una fecha válida en formato DÍA/MES/AÑO " ; # MENSAGEM ALTERADA
        echo "Por ejemplo: 21/04/2028" ; 
        tput sgr0
        echo ""
        exit 1	
    fi

    # Converte DD/MM/AAAA para AAAA-MM-DD (formato do sistema para chage)
    sysdate="$(echo "$udata" | awk -v FS=/ -v OFS=- '{print $3,$2,$1}')"
    
    # VALIDAÇÃO 4: Verifica se a data é sintaticamente válida e existe
    if ! date -d "$sysdate" > /dev/null  2>&1
    then
        echo ""
        tput setaf 7 ; tput setab 1 ; tput bold ;
        echo "Ingresó una fecha inválida o inexistente (ej: 30/02/2028)." ; # MENSAGEM ALTERADA
        echo "Ingrese una fecha válida en formato DÍA/MES/AÑO" ; # MENSAGEM ALTERADA
        echo "Por ejemplo: 21/04/2028" ;
        tput sgr0
        echo ""
        exit 1
    fi

    # VALIDAÇÃO 5: Verifica se a data é futura
    today="$(date -d today +"%Y%m%d")"
    timemachine="$(date -d "$sysdate" +"%Y%m%d")"

    if [ $today -ge $timemachine ]
    then
        echo ""
        tput setaf 7 ; tput setab 1 ; tput bold ;	
        echo "La fecha ingresada es pasada o el día actual." ; # MENSAGEM ALTERADA
        echo "Ingrese una fecha futura y válida en formato DÍA/MES/AÑO" ; # MENSAGEM ALTERADA
        echo "Por ejemplo: 21/04/2028" ;
        tput sgr0
        echo ""
        exit 1
    else
        # SUCESSO
        chage -E "$sysdate" "$usuario"
        echo ""
        tput setaf 7 ; tput setab 4 ; tput bold ;
        echo "¡Éxito! Usuario $usuario, nueva fecha: $udata " ; # MENSAGEM ALTERADA
        tput sgr0
        echo ""
        exit 0
    fi
else
    # ERRO: Usuário não existe no sistema
    echo " "
    tput setaf 7 ; tput setab 1 ;
    tput bold ;	echo "¡El usuario $usuario no existe!" ; tput sgr0 # MENSAGEM ALTERADA
    echo "
"
    exit 1
fi
