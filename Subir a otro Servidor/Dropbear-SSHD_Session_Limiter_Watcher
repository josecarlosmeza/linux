#!/bin/bash
# Script: install_watcher_service.sh
# Propósito: Instala el limitador de sesiones Dropbear/SSHD (Watcher) como un servicio systemd.

# --- VARIABLES DE CONFIGURACIÓN ---
WATCHER_SCRIPT="/usr/local/bin/dropbear_watcher.sh"
SERVICE_NAME="dropbear-watcher.service"
SERVICE_FILE="/etc/systemd/system/$SERVICE_NAME"
DATABASE="/root/usuarios.db"
AUTH_LOG_FILE="/var/log/secure"
LOG_KILL_FILE="/var/log/session_kill.log"

# --- VERIFICACIONES PREVIAS ---
if [[ $EUID -ne 0 ]]; then
   echo "Error: Este script debe ejecutarse como root."
   exit 1
fi

if [[ ! -f "$DATABASE" ]]; then
    echo "Error: El archivo de base de datos ($DATABASE) no existe."
    exit 1
fi

# --- 1. CREAR EL SCRIPT EJECUTABLE DEL WATCHER ---
echo "## 1. Creando script del observador ($WATCHER_SCRIPT)..."

cat > "$WATCHER_SCRIPT" << EOF
#!/bin/bash
database="$DATABASE"
AUTH_LOG_FILE="$AUTH_LOG_FILE"
LOG_KILL_FILE="$LOG_KILL_FILE"

get_active_session_count() {
    local target_user=\$1
    local active_count=0
    SUCCESS_LINES=\$(grep -E 'Accepted password|Password auth succeeded|session opened' "\$AUTH_LOG_FILE" | grep -w "\$target_user")

    if [[ -n "\$SUCCESS_LINES" ]]; then
        local pids=""
        pids+=\$(echo "\$SUCCESS_LINES" | grep "dropbear" | sed -E 's/.*dropbear\[([0-9]+)\].*/\1/')
        pids+=" "
        pids+=\$(echo "\$SUCCESS_LINES" | grep "sshd" | sed -E 's/.*sshd\[([0-9]+)\].*/\1/')
        REGISTERED_PIDS=\$(echo "\$pids" | tr ' ' '\n' | grep -v '^$' | sort -u)

        for pid in \$REGISTERED_PIDS; do
            if ps -p "\$pid" > /dev/null 2>&1; then
                active_count=\$((active_count + 1))
            fi
        done
    fi
    echo "\$active_count"
}

while true; do
    while IFS=' ' read -r user s2ssh _ 
    do  
        user=\$(echo "\$user" | xargs)
        s2ssh=\$(echo "\$s2ssh" | xargs)
        
        if [[ -z "\$s2ssh" || "\$s2ssh" -eq 0 ]]; then
            continue
        fi

        CURRENT_SESSIONS=\$(get_active_session_count "\$user")
        
        if [[ "\$CURRENT_SESSIONS" -gt "\$s2ssh" ]]; then
            
            # Obtener TODOS los PIDs activos (ordenados de más nuevo a más viejo)
            ALL_ACTIVE_PIDS=\$(
                grep -E 'Accepted password|Password auth succeeded|session opened' "\$AUTH_LOG_FILE" | 
                grep -w "\$user" | 
                sed -E -e '/dropbear/! s/.*sshd\[([0-9]+)\].*/\1/g' -e '/sshd/! s/.*dropbear\[([0-9]+)\].*/\1/g' |
                tr -s ' ' '\n' | grep -v '^$' | sort -nr | 
                while read pid; do
                    ps -p \$pid >/dev/null 2>&1 && echo "\$pid"
                done
            )
            
            PID_TO_KILL=\$(echo "\$ALL_ACTIVE_PIDS" | head -1)

            if [[ -n "\$PID_TO_KILL" ]]; then
                kill "\$PID_TO_KILL" 2>/dev/null
                echo "\$(date): KILLED PID \$PID_TO_KILL for user \$user. Limit exceeded (\$CURRENT_SESSIONS/\$s2ssh)" >> "\$LOG_KILL_FILE"
            fi
        fi
        
    done < "\$database"
    
    sleep 5
done
EOF

chmod +x "$WATCHER_SCRIPT"
touch "$LOG_KILL_FILE"
echo "Script del observador creado y permisos establecidos."
echo "---"

# --- 2. CREAR EL ARCHIVO DE UNIDAD SYSTEMD ---
echo "## 2. Creando archivo de servicio Systemd ($SERVICE_FILE)..."

cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Dropbear/SSHD Session Limiter Watcher
After=network.target

[Service]
Type=simple
User=root
ExecStart=$WATCHER_SCRIPT
Restart=always
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

echo "Archivo de servicio Systemd creado."
echo "---"

# --- 3. HABILITAR E INICIAR EL SERVICIO ---
echo "## 3. Habilitando e iniciando el servicio..."

# Recargar la configuración de systemd
sudo systemctl daemon-reload

# Iniciar el servicio
sudo systemctl start "$SERVICE_NAME"

# Habilitar el inicio automático al boot
sudo systemctl enable "$SERVICE_NAME"

echo "--- INSTALACIÓN COMPLETA ---"
echo "✅ El servicio de limitación de sesiones '$SERVICE_NAME' ha sido instalado e iniciado."
echo "Para verificar el estado: sudo systemctl status $SERVICE_NAME"
echo "Para ver los cierres forzados: tail -f $
LOG_KILL_FILE"

exit 0
