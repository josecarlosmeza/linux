#!/bin/bash
# -------------------------------------------------------------------
# DESPLIEGUE FINAL: Instala, configura y activa el Monitor de Sesiones V4.2
# INCLUYE CHEQUEO DE DEPENDENCIAS Y UTILIDADES
# -------------------------------------------------------------------

# ===================================================================
# ðŸ”‘ CONFIGURACIÃ“N: AJUSTA ESTOS VALORES
# ===================================================================
# Define la frecuencia de escaneo. Ejemplos: "30s", "1min", "5min"
SCAN_INTERVAL="1min" 

# Archivos de la soluciÃ³n
MONITOR_SCRIPT="/usr/local/bin/session-killer.sh"
TIMER_SERVICE="session-killer.service"
TIMER_FILE="/etc/systemd/system/${TIMER_SERVICE%.service}.timer"
SERVICE_FILE="/etc/systemd/system/${TIMER_SERVICE}"
DB_FILE="/root/usuarios.db"

echo "======================================================="
echo "âœ… INICIANDO DESPLIEGUE COMPLETO DEL MONITOR V4.2"
echo "======================================================="

# --- FUNCIÃ“N DE VERIFICACIÃ“N DE DEPENDENCIAS ---
check_dependencies() {
    echo "--- 0. Verificando dependencias esenciales..."

    # Verificar si 'journalctl' (Systemd logging) estÃ¡ disponible
    if ! command -v journalctl &> /dev/null; then
        echo "ðŸš¨ ERROR: 'journalctl' (Systemd) no se encuentra o no estÃ¡ configurado."
        echo "Este script requiere Systemd y sus servicios de log."
        exit 1
    else
        echo "   [OK] Systemd logging (journalctl) disponible."
    fi

    # Intentar instalar o asegurar las utilidades de texto esenciales (para CentOS/RHEL)
    if command -v yum &> /dev/null; then
        echo "   [INFO] Intentando asegurar utilidades de texto (gawk, sed)..."
        sudo yum install -y gawk sed > /dev/null 2>&1
    elif command -v apt &> /dev/null; then
        echo "   [INFO] Intentando asegurar utilidades de texto (gawk, sed)..."
        sudo apt update > /dev/null 2>&1
        sudo apt install -y gawk sed > /dev/null 2>&1
    fi
    
    # Verificar si el archivo de lÃ­mites existe
    if [ ! -f "$DB_FILE" ]; then
        echo "âš ï¸ ADVERTENCIA: El archivo de lÃ­mites (${DB_FILE}) no existe. Creando uno de ejemplo."
        echo "REDLIBRE 2" | sudo tee -a "$DB_FILE" > /dev/null
    fi
}

# --- EJECUCIÃ“N DE VERIFICACIÃ“N ---
check_dependencies
echo "-------------------------------------------------------"

# --- 1. Crear el SCRIPT DE EJECUCIÃ“N (${MONITOR_SCRIPT}) ---
echo "1. Creando script de limitaciÃ³n (${MONITOR_SCRIPT})..."
sudo tee ${MONITOR_SCRIPT} > /dev/null <<'EOF'
#!/bin/bash
# MONITOR V4.2: Optimizado para matar todas las sesiones excedentes en una sola ejecuciÃ³n.

DB_FILE="/root/usuarios.db"
LOG_PERIOD="5 minutes ago" 

if [ -f "$DB_FILE" ]; then
    cat "$DB_FILE" | while read -r USER LIMIT; do
        if [[ "$LIMIT" =~ ^[0-9]+$ ]] && [ "$LIMIT" -gt 0 ]; then
            
            PIDS_LOG=$(journalctl --since "$LOG_PERIOD" | \
                       grep "Password auth succeeded for '${USER}'" | \
                       awk '{print $5}' | \
                       sed 's/dropbear\[//; s/]:$//' | \
                       grep -E '^[0-9]+$')

            COUNT=$(echo "$PIDS_LOG" | wc -l)
            
            if [ "$COUNT" -gt "$LIMIT" ]; then
                
                NUM_TO_KILL=$((COUNT - LIMIT))
                PIDS_TO_KILL=$(echo "$PIDS_LOG" | tail -n "$NUM_TO_KILL")
                
                for PID in $PIDS_TO_KILL; do
                    kill "$PID" 2>/dev/null
                    logger -t session-killer "KILLED (Batch) session for ${USER} (Excess: ${NUM_TO_KILL}). PID: $PID"
                done
            fi
        fi
    done
fi
EOF
sudo chmod +x ${MONITOR_SCRIPT}
echo "   âœ… Script V4.2 creado."

# --- 2. Crear el ARCHIVO DE SERVICIO (.service) ---
echo "2. Creando archivo de servicio Systemd (${TIMER_SERVICE})..."
sudo tee ${SERVICE_FILE} > /dev/null <<EOF
[Unit]
Description=Dropbear Session Killer Service
Requires=network.target

[Service]
Type=oneshot
ExecStart=/bin/bash ${MONITOR_SCRIPT}
CPUAccounting=true
MemoryAccounting=true
EOF
echo "   âœ… Archivo de servicio creado."

# --- 3. Crear el ARCHIVO DE TIEMPO (.timer) ---
echo "3. Creando archivo de tiempo (${TIMER_FILE})..."
sudo tee ${TIMER_FILE} > /dev/null <<EOF
[Unit]
Description=Run Dropbear Session Killer every ${SCAN_INTERVAL}

[Timer]
OnBootSec=30s
OnUnitActiveSec=${SCAN_INTERVAL}
AccuracySec=1s

[Install]
WantedBy=timers.target
EOF
echo "   âœ… Archivo de tiempo configurado para ${SCAN_INTERVAL}."

# --- 4. ACTIVACIÃ“N FINAL ---
echo "4. Activando y reiniciando Systemd..."
sudo systemctl daemon-reload
sudo systemctl enable session-killer.timer
sudo systemctl start session-killer.timer

echo "======================================================="
echo "ðŸ¥³ Â¡DESPLIEGUE COMPLETO Y VERIFICADO! Monitor Activo."
echo "======================================
================="
