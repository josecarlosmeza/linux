#!/bin/bash
#====================================================
#	SCRIPT: CONEXAO REDLIBRE
#   DATA ATT:   15 de Jul 2020
#	REDLIBRE
#====================================================
_lvk=$(wget -qO- https://raw.githubusercontent.com/AAAAAEXQOSyIpN2JZ0ehUQ/SSHPLUS-MANAGER-FREE/master/Install/versao)
IP=$(wget -qO- ipv4.icanhazip.com)
IP2=$(wget -qO- http://whatismyip.akamai.com/)
[[ "$IP" != "$IP2" ]] && ipdovps="$IP2" || ipdovps="$IP"
echo -e "$ipdovps" >/etc/IP
lst=$1 && lst1=$2 && lst2=$3 && key1=$4 && key2=crz
echo -e "America/Sao_Paulo" >/etc/timezone 2>/dev/null || true
ln -fs /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime >/dev/null 2>&1
if command -v timedatectl &>/dev/null; then timedatectl set-timezone America/Sao_Paulo 2>/dev/null || true; else dpkg-reconfigure --frontend noninteractive tzdata >/dev/null 2>&1; fi
[[ -z $lst1 ]] && {
	rm -rf $_Ink/list >/dev/null 2>&1 && cat /dev/null >~/.bash_history && history -c && exit 0
}
[[ ! -d /etc/RedLibre ]] && mkdir /etc/RedLibre
[[ ! -d /etc/RedLibre/senha ]] && mkdir /etc/RedLibre/senha
[[ ! -e /etc/RedLibre/Exp ]] && touch /etc/RedLibre/Exp
[[ ! -d /etc/RedLibre/userteste ]] && mkdir /etc/RedLibre/userteste
[[ ! -d /etc/bot ]] && mkdir /etc/bot
[[ ! -d /etc/bot/info-users ]] && mkdir /etc/bot/info-users
[[ ! -d /etc/bot/arquivos ]] && mkdir /etc/bot/arquivos
[[ ! -d /etc/bot/revenda ]] && mkdir /etc/bot/revenda
[[ ! -d /etc/bot/suspensos ]] && mkdir /etc/bot/suspensos
[[ ! -e /etc/bot/lista_ativos ]] && touch /etc/bot/lista_ativos
[[ ! -e /etc/bot/lista_suspensos ]] && touch /etc/bot/lista_suspensos
echo -e 'by: RedLibre' >/usr/lib/redlibre && cat /usr/lib/redlibre >$lst2/licence
# Apache2 (Debian) ou httpd (AlmaLinux): só altera porta se estiver em uso
if command -v netstat &>/dev/null; then _p80=$(netstat -nplt 2>/dev/null | grep -w '80'); else _p80=$(ss -nplt 2>/dev/null | grep -w ':80'); fi
[[ -n "$_p80" ]] && [[ -f /etc/apache2/ports.conf ]] && sed -i "s/Listen 80/Listen 81/g" /etc/apache2/ports.conf && (command -v systemctl &>/dev/null && systemctl restart apache2 2>/dev/null || service apache2 restart 2>/dev/null)
[[ -n "$_p80" ]] && [[ -f /etc/httpd/conf/httpd.conf ]] && sed -i "s/Listen 80/Listen 81/g" /etc/httpd/conf/httpd.conf && (command -v systemctl &>/dev/null && systemctl restart httpd 2>/dev/null || true)
[[ "$(grep -o '#Port 22' /etc/ssh/sshd_config 2>/dev/null)" == "#Port 22" ]] && sed -i "s;#Port 22;Port 22;" /etc/ssh/sshd_config && (command -v systemctl &>/dev/null && (systemctl restart sshd 2>/dev/null || systemctl restart ssh 2>/dev/null) || service sshd restart 2>/dev/null)
grep -v "^PasswordAuthentication" /etc/ssh/sshd_config >/tmp/passlogin && mv /tmp/passlogin /etc/ssh/sshd_config
echo "PasswordAuthentication yes" >>/etc/ssh/sshd_config
_dir1='/bin'
_dir2='/etc/RedLibre'
rm -f $_dir2/ShellBot.sh $_dir2/cabecalho $_dir2/open.py $_dir2/proxy.py >/dev/null 2>&1
_mdls=("addhost" "delhost" "alterarsenha" "criarusuario" "expcleaner" "mudardata" "remover" "criarteste" "verifbot" "droplimiter" "alterarlimite" "ajuda" "sshmonitor" "badvpn" "userbackup" "blockt" "otimizar" "menu" "speedtest" "banner" "senharoot" "reiniciarservicos" "reiniciarsistema" "attscript" "conexao" "delscript" "detalhes" "botssh" "infousers" "verifatt" "limiter" "uexpired" "instsqd" "cabecalho" "bot" "open.py" "proxy.py")
for _arq in ${_mdls[@]}; do
	[[ -e $_dir1/$_arq ]] && rm $_dir1/$_arq >/dev/null 2>&1
	wget -c -P $_dir1 https://github.com/josecarlosmeza/linux/raw/main/Subir%20a%20otro%20Servidor/Modulos/$_arq
	chmod +x $_dir1/$_arq
done
mv $_dir1/cabecalho $_dir1/bot $_dir1/open.py $_dir1/proxy.py $_dir2
_arq_host="/etc/hosts"
_host[0]="d1n212ccp6ldpw.cloudfront.net"
_host[1]="dns.whatsapp.net"
_host[2]="portalrecarga.vivo.com.br/recarga"
_host[3]="navegue.vivo.com.br/controle/"
_host[4]="navegue.vivo.com.br/pre/"
_host[5]="www.whatsapp.net"
_host[6]="/REDLIBRE?"
for host in ${_host[@]}; do
	if [[ "$(grep -w "$host" $_arq_host | wc -l)" = "0" ]]; then
		sed -i "3i\127.0.0.1 $host" $_arq_host
	fi
done
[[ ! -e /etc/autostart ]] && {
	echo '#!/bin/bash
clear
#INICIO AUTOMÁTICO' >/etc/autostart
	chmod +x /etc/autostart
} || {
	[[ $(ps x | grep "bot_plus" | grep -v grep | wc -l) != '0' ]] && wget -qO- https://raw.githubusercontent.com/shellscriptx/shellbot/master/ShellBot.sh >/etc/RedLibre/ShellBot.sh
	for proc in $(ps x | grep 'dmS' | grep -v 'grep' | awk {'print $1'}); do
		screen -r -S "$proc" -X quit
	done
	screen -wipe >/dev/null
	echo '#!/bin/bash
clear
#INICIO AUTOMÁTICO' >/etc/autostart
	chmod +x /etc/autostart
}
crontab -r >/dev/null 2>&1
(
	crontab -l 2>/dev/null
	echo "@daily /bin/verifatt"
	echo "@reboot /etc/autostart"
	echo "* * * * * /etc/autostart"
	echo "0 */6 * * * /bin/uexpired"
) | crontab -
/bin/uexpired 2>/dev/null || true
echo "$_lvk" | sed -n '1 p' | cut -d' ' -f2 >/bin/versao && cat /bin/versao >/home/redlibre 2>/dev/null || true
# jq: AlmaLinux/RHEL tem nos repos; Debian pode precisar do binário
if ! command -v jq &>/dev/null; then
  (command -v dnf &>/dev/null && dnf install -y jq 2>/dev/null) || (command -v yum &>/dev/null && yum install -y jq 2>/dev/null) || (wget -q https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64 -O /tmp/jq-linux64 2>/dev/null && chmod +x /tmp/jq-linux64 && mv /tmp/jq-linux64 /usr/local/bin/jq 2>/dev/null)
fi
if command -v systemctl &>/dev/null; then systemctl restart crond 2>/dev/null || systemctl restart cron 2>/dev/null; else service cron restart 2>/dev/null; fi
if command -v systemctl &>/dev/null; then systemctl restart sshd 2>/dev/null || systemctl restart ssh 2>/dev/null; else service sshd restart 2>/dev/null; fi
[[ -d /var/www/html/openvpn ]] && (command -v systemctl &>/dev/null && (systemctl restart httpd 2>/dev/null || systemctl restart apache2 2>/dev/null) || service apache2 restart 2>/dev/null)
rm -rf $lst1/list >/dev/null 2>&1
